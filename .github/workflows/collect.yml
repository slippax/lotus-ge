name: OSRS Data Collector
on:
  workflow_dispatch: # Manual trigger button
  repository_dispatch: # External trigger via API
    types: [collect-data]

permissions:
  contents: write # Required for git push

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Get fresh Dropbox access token
        run: |
          echo "ğŸ”„ Refreshing Dropbox access token..."

          # Get fresh access token using refresh token
          RESPONSE=$(curl -X POST https://api.dropboxapi.com/oauth2/token \
            -d grant_type=refresh_token \
            -d refresh_token="${{ secrets.DROPBOX_REFRESH_TOKEN }}" \
            -d client_id="${{ secrets.DROPBOX_APP_KEY }}" \
            -d client_secret="${{ secrets.DROPBOX_APP_SECRET }}" \
            --silent)

          # Extract access token from response using Python
          ACCESS_TOKEN=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['access_token'])" 2>/dev/null || echo "")

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "âŒ Failed to refresh Dropbox access token"
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "âœ… Successfully refreshed Dropbox access token"
          # Store token for use in subsequent steps
          echo "FRESH_DROPBOX_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV

      - name: Download existing database
        run: |
          mkdir -p data
          echo "ğŸ”„ Attempting to download existing database from Dropbox..."

          # Try to download existing database from Dropbox with fresh token
          HTTP_CODE=$(curl -X POST https://content.dropboxapi.com/2/files/download \
            --header "Authorization: Bearer $FRESH_DROPBOX_TOKEN" \
            --header "Dropbox-API-Arg: {\"path\": \"/osrsmarketdata.sqlite\"}" \
            --output data/osrsmarketdata.sqlite \
            --write-out "%{http_code}" \
            --silent)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Successfully downloaded existing database from Dropbox"
            ls -la data/osrsmarketdata.sqlite
          else
            echo "âŒ Failed to download database from Dropbox"
            echo "HTTP Status Code: $HTTP_CODE"

            # Get detailed error information
            echo "ğŸ” Attempting to get detailed error information..."
            curl -X POST https://content.dropboxapi.com/2/files/download \
              --header "Authorization: Bearer $FRESH_DROPBOX_TOKEN" \
              --header "Dropbox-API-Arg: {\"path\": \"/osrsmarketdata.sqlite\"}" \
              --output /dev/null \
              --include \
              --silent || true

            echo "ğŸš¨ CRITICAL: Cannot proceed without existing database - this would lose historical data!"
            echo "Please check:"
            echo "1. Dropbox refresh token validity"
            echo "2. Database file exists at /osrsmarketdata.sqlite in Dropbox"
            echo "3. Dropbox API service status"
            exit 1
          fi

      - name: Collect OSRS data
        run: python collect.py

      - name: Upload updated database
        run: |
          echo "ğŸ”„ Uploading updated database back to Dropbox..."

          # Verify database file exists and has reasonable size
          if [ ! -f "data/osrsmarketdata.sqlite" ]; then
            echo "âŒ Database file not found - cannot upload"
            exit 1
          fi

          DB_SIZE=$(stat -f%z data/osrsmarketdata.sqlite 2>/dev/null || stat -c%s data/osrsmarketdata.sqlite 2>/dev/null)
          echo "ğŸ“Š Database size: $DB_SIZE bytes"

          if [ "$DB_SIZE" -lt 1000 ]; then
            echo "âŒ Database file too small ($DB_SIZE bytes) - likely corrupted"
            exit 1
          fi

          # Upload updated database back to Dropbox with error handling using fresh token
          UPLOAD_RESPONSE=$(curl -X POST https://content.dropboxapi.com/2/files/upload \
            --header "Authorization: Bearer $FRESH_DROPBOX_TOKEN" \
            --header "Dropbox-API-Arg: {\"path\": \"/osrsmarketdata.sqlite\", \"mode\": \"overwrite\"}" \
            --header "Content-Type: application/octet-stream" \
            --data-binary @data/osrsmarketdata.sqlite \
            --write-out "HTTPSTATUS:%{http_code}" \
            --silent)

          # Extract HTTP status code from response
          HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$UPLOAD_RESPONSE" | sed 's/HTTPSTATUS:[0-9]*$//')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Successfully uploaded updated database to Dropbox"
            echo "ğŸ“ File info: $(echo "$RESPONSE_BODY" | python3 -c "import sys, json; data=json.load(sys.stdin); print(f\"{data['name']} ({data['size']} bytes)\")" 2>/dev/null || echo "Upload confirmed")"
          else
            echo "âŒ Failed to upload database to Dropbox"
            echo "HTTP Status Code: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            echo "ğŸš¨ WARNING: Database changes not backed up to Dropbox!"
            exit 1
          fi

      - name: Commit and push analysis results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "OSRS Data Collector"

          # Debug: Check what files exist
          echo "ğŸ” Files in data directory:"
          ls -la data/ || echo "No data directory"
          echo "ğŸ” Files in data/summaries directory:"
          ls -la data/summaries/ || echo "No summaries directory"

          # Check git status before adding
          echo "ğŸ” Git status before add:"
          git status --porcelain data/summaries/ || echo "No changes detected"

          # Only commit analysis results, not the raw database
          echo "ğŸ” Running git add command..."
          git add data/summaries/ || echo "Failed to add summaries directory"
          git add data/*.json 2>/dev/null || echo "No JSON files in data root"
          git add data/*.csv 2>/dev/null || echo "No CSV files in data root"

          # Debug: Check what's staged
          echo "ğŸ” Staged changes:"
          git diff --staged --name-only || echo "No staged changes"

          # Show actual differences
          echo "ğŸ” Summary file timestamps:"
          head -3 data/summaries/*.json | grep -E "(updated|==)" || echo "No timestamp info"

          if ! git diff --staged --quiet; then
            git commit -m "Data collection: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "âœ“ Analysis results committed and pushed"

            # Notify users of instant data update
            curl -X POST "https://ntfy.sh/osrs-ge-lotus-updates" \
              -H "Title: OSRS Market Data Updated" \
              -d "refresh"
          else
            echo "â„¹ No changes to commit"
          fi
